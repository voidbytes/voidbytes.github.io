<!DOCTYPE html><html lang="zh-cn" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>如何使错误日志更加方便排查问题 | 小白的编程札记</title><meta name="author" content=" 小白 "><meta name="copyright" content=" 小白 "><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="作者 | 琴水玉 来源 | https:&#x2F;&#x2F;cnblogs.com&#x2F;lovesqcc&#x2F;p&#x2F;4319594.html 在程序中打错误日志的主要目标是为更好地排查问题和解决问题提供重要线索和指导。但是在实际中打的错误日志内容和格式变化多样，错误提示上可能残缺不全、没有相关背景、不明其义，使得排查解决问题成为非常不方便或者耗时的操作。而实际上，如果编程的时候稍加用心，就会减少排查问题的很多无用功。 在"><meta property="og:type" content="article"><meta property="og:title" content="如何使错误日志更加方便排查问题"><meta property="og:url" content="https://voidbytes.com/posts/209595582/index.html"><meta property="og:site_name" content="小白的编程札记"><meta property="og:description" content="作者 | 琴水玉 来源 | https:&#x2F;&#x2F;cnblogs.com&#x2F;lovesqcc&#x2F;p&#x2F;4319594.html 在程序中打错误日志的主要目标是为更好地排查问题和解决问题提供重要线索和指导。但是在实际中打的错误日志内容和格式变化多样，错误提示上可能残缺不全、没有相关背景、不明其义，使得排查解决问题成为非常不方便或者耗时的操作。而实际上，如果编程的时候稍加用心，就会减少排查问题的很多无用功。 在"><meta property="og:locale"><meta property="og:image" content="https://voidbytes.com/img/34d5bb5d3744e6d1d83703ab0e20da2f_xll.jpg"><meta property="article:published_time" content="2023-08-24T08:00:00.000Z"><meta property="article:modified_time" content="2023-08-24T08:00:00.000Z"><meta property="article:author" content=" 小白 "><meta property="article:tag" content="转载"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://voidbytes.com/img/34d5bb5d3744e6d1d83703ab0e20da2f_xll.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "如何使错误日志更加方便排查问题",
  "url": "https://voidbytes.com/posts/209595582/",
  "image": "https://voidbytes.com/img/34d5bb5d3744e6d1d83703ab0e20da2f_xll.jpg",
  "datePublished": "2023-08-24T08:00:00.000Z",
  "dateModified": "2023-08-24T08:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": " 小白 ",
      "url": "https://voidbytes.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://voidbytes.com/posts/209595582/index.html"><link rel="preconnect"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//static.cloudflareinsights.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/pluginsSrc/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script>(() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-2253275085764952",enable_page_level_ads:"true"})</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?3d9a712cb35c03011599a3cbebc08968";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-TPPKTP3FCP"></script><script>window.dataLayer = window.dataLayer || []
function gtag(){dataLayer.push(arguments)}
gtag('js', new Date())
gtag('config', 'G-TPPKTP3FCP')
btf.addGlobalFn('pjaxComplete', () => {
  gtag('config', 'G-TPPKTP3FCP', {'page_path': window.location.pathname})
}, 'google_analytics')</script><script defer data-pjax="data-pjax" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;038395b9390c4140975c022799210743&quot;}"></script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"No results found for: ${query}","hits_stats":"${hits} articles found"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"如何使错误日志更加方便排查问题",isHighlightShrink:!1,isToc:!1,pageType:"post"}</script><meta name="generator" content="Hexo 7.3.0"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style><link rel="alternate" href="/atom.xml" title="小白的编程札记" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="小白的编程札记" type="application/rss+xml"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      if ($loadingBox.classList.contains('loaded')) return
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()

  if (document.readyState === 'complete') {
    preloader.endLoading()
  } else {
    window.addEventListener('load', preloader.endLoading)
    document.addEventListener('DOMContentLoaded', preloader.endLoading)
    // Add timeout protection: force end after 7 seconds
    setTimeout(preloader.endLoading, 7000)
  }

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/34d5bb5d3744e6d1d83703ab0e20da2f_xll.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">82</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">52</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> Travelling</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/guestbook/"><i class="fa-fw fas fa-comment-dots"></i><span> Guestbook</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://today.voidbytes.com/pic/today.webp)"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">小白的编程札记</span></a><a class="nav-page-title" href="/"><span class="site-name">如何使错误日志更加方便排查问题</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span> Back to Home</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-subway"></i><span> Travelling</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fas fa-link"></i><span> Links</span></a></div><div class="menus_item"><a class="site-page" href="/guestbook/"><i class="fa-fw fas fa-comment-dots"></i><span> Guestbook</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">如何使错误日志更加方便排查问题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-08-24T08:00:00.000Z" title="Created 2023-08-24 00:00:00">2023-08-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-08-24T08:00:00.000Z" title="Updated 2023-08-24 00:00:00">2023-08-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">5.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>17mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:500,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2023-08-24 00:00:00&quot;}" hidden></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/posts/209595582/640-20230824234051902.jpeg" alt="Image"></p><p>作者 | 琴水玉</p><p>来源 | <a target="_blank" rel="noopener" href="https://cnblogs.com/lovesqcc/p/4319594.html">https://cnblogs.com/lovesqcc/p/4319594.html</a></p><p>在程序中打错误日志的主要目标是为更好地排查问题和解决问题提供重要线索和指导。但是在实际中打的错误日志内容和格式变化多样，错误提示上可能残缺不全、没有相关背景、不明其义，使得排查解决问题成为非常不方便或者耗时的操作。而实际上，如果编程的时候稍加用心，就会减少排查问题的很多无用功。 在阐述如何编写有效的错误日志之前， 了解错误是怎么产生的， 非常重要。</p><p><strong>错误是如何炼成的</strong></p><p>对于当前系统来说， 错误的产生由三个地方引入：</p><p>1.上层系统引入的非法参数。对于非法参数引入的错误， 可以通过参数校验和前置条件校验来截获错误；</p><p>2.与下层系统交互产生的错误。与下层交互产生的错误， 有两种：</p><p>a.下层系统处理成功了，但是通信出错了， 这样会导致子系统之间的数据不一致；</p><p>对于这种情况， 可以采用超时补偿机制，预先将任务记录下来，通过定时任务在后续将数据订正过来。</p><p>更好的设计方案 ？</p><p>b.通信成功了，但是下层处理出错了。</p><p>对于这种情况， 需要与下层开发人员沟通， 协调子系统之间的交互；</p><p>需要根据下层返回的错误码和错误描述做适当的处理或给予合理的提示信息。</p><p>无论哪一种情况， 都要假设下层系统可靠性一般， 做好出错的设计考虑。</p><p>3.本层系统处理出错。</p><p>本层系统产生错误的原因：</p><p><strong>原因一：疏忽导致。</strong> 疏忽是指程序员能力完全可避免此类错误但实际上没做到。比如将 &amp;&amp; 敲成了 &amp; ， == 敲成了 = ；边界错误， 复合逻辑判断错误等。疏忽要么是程序员注意力不够集中， 比如处于疲倦状态、加班通宵、边开会边写程序；要么是急着实现功能，没有顾及程序的健壮性等。</p><p>改进措施：使用代码静态分析工具，通过单元测试行覆盖可有效避免此类问题。</p><p><strong>原因二：错误与异常处理不够周全导致的。</strong> 比如输入问题。计算两个数相加， 不仅要考虑计算溢出问题， 还要考虑输入非法的情形。对于前者，可能通过了解、犯错或经验就可以避免， 而对于后者，则必须加以限定，以使之处于我们的智商能够控制的范围内，比如使用正则表达式过滤掉不合法的输入。对于正则表达式必须进行测试。对于不合法输入， 要给出尽可能详细、易懂、友好的提示信息、原因及建议方案。</p><p>改进措施：尽可能周全地考虑各种错误情形和异常处理。在实现主流程之后，增加一个步骤：仔细推敲可能的各种错误和异常，返回合理错误码和错误描述。每个接口或模块都有效处理好自己的错误和异常，可有效避免因场景交互复杂导致的bug. 譬如，一个业务用例由场景A.B.C交互完成。实际执行A.B成功了，C失败了，这时B需要根据C返回合理的代码和消息进行回滚并返回给A合理的代码和消息，A根据B的返回进行回滚，并返回给客户端合理的代码和消息。这是一种分段回滚的机制，要求每个场景都必须考虑异常情况下的回滚。</p><p><strong>原因三：逻辑耦合紧密导致。</strong> 由于业务逻辑耦合紧密， 随着软件产品一步步发展， 各种逻辑关系错综复杂， 难以看到全局状况， 导致局部修改影响波及到全局范围，造成不可预知的问题。</p><p>改进措施：编写短函数和短方法， 每个函数或方法最好不超过 50 行。编写无状态函数和方法， 只读全局状态， 相同的前提条件总是会输出相同的结果， 不会依赖外部状态而变更自己的行为；定义合理的结构、 接口和逻辑段， 使接口之间的交互尽可能正交、低耦合；对于服务层， 尽可能提供简单、正交的接口；持续重构， 保持应用模块化和松耦合， 理清逻辑依赖关系。对于有大量业务接口相互影响的情况， 必须整理各个业务接口的逻辑流程及相互依赖关系， 从整体上进行优化；对于有大量状态的实体， 也需要梳理相关的业务接口， 整理状态之间的转换关系。</p><p><strong>原因四：算法不正确导致。</strong></p><p>改进措施：首先将算法从应用中分离出来。若算法有多种实现， 可以通过交叉校验的单元测试找出来， 比如排序操作；如果算法具有可逆性质， 可以通过可逆校验的单元测试找出来， 比如加密解密操作。</p><p><strong>原因五：相同类型的参数，传入顺序错误导致。</strong> 比如，modifyFlow(int rx, int tx), 实际调用为 modifyFlow(tx,rx)</p><p>改进措施：尽可能使类型具体化， 该用浮点数就用浮点数， 该用字符串就用字符串， 该用具体对象类型就用具体对象类型；相同类型的参数尽可能错开；如果上述都无法满足， 就必须通过接口测试来验证， 接口参数值务必是不同的。</p><p><strong>原因六：空指针异常。</strong> 空指针异常通常是对象没有正确初始化， 或者使用对象之前没有对对象是否非空做检测。</p><p>改进措施：对于配置对象， 检测其是否成功初始化；对于普通对象， 获取到实体对象使用之前， 检测是否非空。</p><p><strong>原因七：网络通信错误。</strong> 网络通信错误通常是因为网络延迟、阻塞或不通导致的错误。网络通信错误通常是小概率事件， 但小概率事件很可能会导致大面积的故障、 难以复现的BUG。</p><p>改进措施：在前一个子系统的结束点和后一个子系统的入口点分别打 INFO 日志。通过两者的时间差提供一点线索。</p><p><strong>原因八：事务与并发错误。</strong> 事务与并发结合在一起， 很容易产生非常难以定位的错误。</p><p>改进措施：对于程序中的并发操作， 涉及到共享变量及重要状态修改的， 要加 INFO 日志。更有效的做法？？？</p><p><strong>原因九：配置错误。</strong></p><p>改进措施：在启动应用或启动相应配置时， 检测所有的配置项， 打印相应的INFO日志， 确保所有配置都加载成功。</p><p><strong>原因十：业务不熟悉导致的错误。</strong> 在中大型系统， 部分业务逻辑和业务交互都比较复杂， 整个的业务逻辑可能存在于多个开发同学的大脑里， 每个人的认识都不是完整的。这很容易导致业务编码错误。</p><p>改进措施：通过多人讨论和沟通， 设计正确的业务用例， 根据业务用例来编写和实现业务逻辑；最终的业务逻辑和业务用例必须完整存档；在业务接口中注明该业务的前置条件、处理逻辑、后置校验和注意事项；当业务变化时， 需要同步更新业务注释；代码REVIEW。业务注释是业务接口的重要文档， 对业务理解起着重要的缓存作用。</p><p><strong>原因十一：设计问题导致的错误。</strong> 比如同步串行方式会有性能、响应慢的问题， 而并发异步方式可以解决性能、响应慢的问题， 但会带来安全、正确性的隐患。异步方式会导致编程模型的改变， 新增异步消息推送和接收等新的问题。使用缓存能够提高性能， 但是又会存在缓存更新的问题。</p><p>改进措施：编写和仔细评审设计文档。设计文档必须阐述背景、需求、所满足的业务目标、要达到的业务性能指标、可能的影响、设计总体思路、详细方案、预见该方案的优缺点及可能的影响；通过测试和验收， 确保改设计方案确实满足业务目标和业务性能指标。</p><p><strong>原因十二：未知细节问题导致的错误。</strong> 比如缓冲区溢出、 SQL 注入攻击。从功能上看是没有问题的， 但是从恶意使用上看， 是存在漏洞的。再比如， 选择 jackson 库做 JSON 字符串解析， 默认情况下， 当对象新增字段时会导致解析出错。必须在对象上加 @JsonIgnoreProperties(ignoreUnknown = true) 注解才能正确应对变化。如果选用其他 JSON 库就不一定有这个问题。</p><p>改进措施：一方面要通过经验积累， 另一方面， 考虑安全问题和例外情况， 选择成熟的经过严格测试的库。</p><p><strong>原因十三：随时间变化而出现的bug。</strong> 有些解决方案在过去看来是很不错的，但在当前或者未来的情景中可能变得笨拙甚至不中用，也是常见的事情。比如像加密解密算法， 在过去可能认为是完善的， 在破解之后就要慎重使用了。</p><p>改进措施：关注变化以及漏洞修复消息，及时修正过时的代码、库、行为。</p><p><strong>原因十四：硬件相关的错误。</strong> 比如内存泄露， 存储空间不足， OutOfMemoryError 等。</p><p>改进措施：增加对应用系统的 CPU / 内存 / 网络等重要指标的性能监控。</p><p>系统出现的常见错误：</p><p>1.实体在数据库中的记录不存在， 必须指明是哪个实体或实体标识；</p><p>2.实体配置不正确， 必须指明是哪个配置有问题，正确的配置应该是什么；</p><p>3.实体资源不满足条件， 必须指明当前资源是什么，资源要求是什么；</p><p>4.实体操作前置条件不满足， 必须指明需要满足什么前置条件，当前的状态是什么；</p><p>5.实体操作后置校验不满足， 必须指明需要满足什么后置校验， 当前的状态是什么；</p><p>6.性能问题导致超时， 必须指明是什么导致的性能问题，后续如何优化；</p><p>7.多个子系统交互通信出错导致之间的状态或数据不一致？</p><p>一般难以定位的错误会出现在比较底层的地方。因为底层无法预知具体的业务场景， 给出的错误消息都是比较通用的。</p><p>这就要求在业务上层提供尽可能丰富的线索。错误的产生一定是多个系统或层次交互的过程中在某一层栈上不满足前置条件导致。在编程时， 在每一层栈中尽可能确保所有必须的前置条件满足，尽可能避免错误的参数传递到底层， 尽可能地将错误截获在业务层。</p><p>大多数错误都是由多种原因组合产生。但每一种错误必定有其原因。在解决错误之后， 要深入分析错误是如何发生的， 如何避免这些错误再次发生。努力就能成功， 但是： <strong>反思才能进步 ！</strong></p><p><strong>如何编写更容易排查问题的错误日志</strong></p><p>打错误日志的基本原则：</p><p>1.尽可能完整。每一条错误日志都完整描述了：什么场景下发生了什么错误， 什么原因（或者哪些可能原因）， 如何解决（或解决提示）；</p><p>2.尽可能具体。比如 NC 资源不足， 究竟具体指什么资源不足， 是否可以通过程序直接指明；通用错误，比如 VM NOT EXIST ， 要指明在什么场景下发生的，可能便于后续统计的工作。</p><p>3.尽可能直接。最理想的错误日志应该让人在第一直觉下能够知道是什么原因导致，该怎么去解决，而不是还要通过若干步骤去查找真正的原因。</p><p>4.将已有经验集成直接到系统中。所有已经解决过的问题及经验都要尽可能以友好的方式集成到系统中，给新进人员更好的提示，而不是埋藏在其他地方。</p><p>5.排版要整洁有序， 格式统一化规范化。密密麻麻、随笔式的日志看着就揪心， 相当不友好， 也不便于排查问题。</p><p>6.采用多个关键字唯一标识请求，突出显示关键字：时间、实体标识（比如vmname）、操作名称。</p><p>排查问题的基本步骤：</p><p>登录到应用服务器 -&gt; 打开日志文件 -&gt; 定位到错误日志位置 -&gt; 根据错误日志的线索的指导去排查、确认问题和解决问题。</p><p>其中：</p><p>1.从登陆到打开日志文件：由于应用服务器有多台， 要逐一登录上去查看实在不方便。需要编写一个工具放在 AG 上直接在 AG 上查看所有服务器日志， 甚至直接筛选出所需要的错误日志。</p><p>2.定位错误日志位置。目前日志的排版密密麻麻，不易定位到错误日志。一般可以先采用”时间”来定位到错误日志的附近前面的地方， 然后使用 实体关键字 / 操作名称 组合来锁定错误日志地方。根据 requestId 定位错误日志虽然比较符合传统，但是要先找到 requestId , 并且不具有描述性。最好能直接根据时间/内容关键字来定位错误日志位置。</p><p>3.分析错误日志。错误日志的内容最好能够更加直接明了， 能够明确指明与当前要排查的问题特征是吻合的， 并且给出重要线索。</p><p>通常， 程序错误日志的问题就是日志内容是针对当前代码情境才能理解，看上去简洁， 但总是写的不全， 半英文格式；一旦离开代码情境， 就很难知道究竟说的是什么， 非要让人思考一下或者去看看代码才能明白日志说的是什么含义。这不是自己给自己罪受？</p><p>比如：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if ((storageType == StorageType.dfs1 || storageType == StorageType.dfs2)</span><br><span class="line">                &amp;&amp; (zone.hasStorageType(StorageType.io3) || zone.hasStorageType(StorageType.io4))) {</span><br><span class="line">// 进入dfs1 和dfs2 在io3 io4 存储。</span><br><span class="line">} else {</span><br><span class="line">      log.info("zone storage type not support, zone: " + zone.getZoneId() + ", storageType: "</span><br><span class="line">+ storageType.name());</span><br><span class="line">      throw new BizException(DeviceErrorCode.ZONE_STORAGE_TYPE_NOT_SUPPORT);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>zone 要支持什么 storage type 才是正确的? Do Not Let Me Think !</p><p>错误日志应该做到：即使离开代码情境，也能清晰地描述发生了什么。</p><p>此外，如果能够直接在错误日志中说明清楚原因， 在做巡检日志的时候也可以省些力气。</p><p>从某种意义上来说， 错误日志也可以是一种非常有益的文档，记录着各种不合法的运行用例。</p><p>目前程序错误日志的内容可能存在如下问题：</p><p><strong>1. 错误日志没有指明错误参数和内容：</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">catch(Exception ex){</span><br><span class="line">      log.error("control ip insert failed", ex);</span><br><span class="line">      return new ResultSet&lt;AddControlIpResponse&gt;(</span><br><span class="line">ControlIpErrorCode.ERROR_CONTROL_IP_INSERT_FAILURE);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>没有指明插入失败的 control ip. 如果加上 control ip 关键字， 更容易搜索和锁定错误。</p><p>类似的还有：</p><p>log.error(“Get some errors when insert subnet and its IPs into database. Add subnet or IP failure.”, e);</p><p>没有指明是哪个 subnet 的它下属的哪些 IP. 值得注意的是， 要指明这些要额外做一些事情， 可能会稍微影响性能。这时候需要权衡性能和可调试性。</p><p>解决方案：使用 String.format(“Some msg to ErrorObj: %s”, errobj) 方法指明错误参数及内容。</p><p>这通常要求对 DO 对象编写可读的 toString 方法。</p><p><strong>2. 错误场景不明确：</strong></p><p>log.error(“nc has exist, nc ip” + request.getIp());</p><p>在 createNc 中检测到 NC 已经存在报错。但是日志上没有指明错误场景， 让人猜测，为什么会报NC已存在错误。</p><p>可以改为</p><p>log.error(“nc has exist when want to create nc, please check nc parameters. Given nc ip: “ + request.getIp());</p><p>log.error(“[create nc] nc has exist, please check nc parameters. Given nc ip: “ + request.getIp());</p><p>类似的还有：</p><p>log.error(“not all vm destroyed, nc id “ + request.getNcId());</p><p>改成 log.error(“[delete nc] some vms [%s] in the nc are not destroyed. nc id: %s”, vmNames, request.getNcId());</p><p>解决方案：错误消息加上 when 字句， 或者错误消息前加上 【接口名】, 指明错误场景，直接从错误日志就知道明白了。</p><p>一般能够知道 executor 的可以加上 【接口名】， service 加上 when 字句。</p><p><strong>3. 内容不明确, 或不明其义：</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(aliMonitorReporter == null) {</span><br><span class="line">        log.error("aliMonitorReporter is null!");</span><br><span class="line">} else {</span><br><span class="line">       aliMonitorReporter.attach(new ThreadPoolMonitor(namePrefix, asynTaskThreadPool.getThreadPoolExecutor()));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>改为：log.error(“aliMonitorReporter is null, probably not initialized properly, please check configuration in file xxx.”);</p><p>类似的还有：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (diskWbps == null &amp;&amp; diskRbps == null &amp;&amp; diskWiops == null    &amp;&amp; diskRiops == null) {</span><br><span class="line">      log.error("none of attribute is specified for modifying");</span><br><span class="line">      throw new BizException(DeviceErrorCode.NO_ATTRIBUTE_FOR_MODIFY);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>改为 log.error(“[modify disk attribute] None of [diskWbps,diskRbps,diskWiops,diskRiops] is specified for disk id:” + diskId);</p><p>解决方案：更清晰贴切地描述错误内容。</p><p><strong>4. 排查问题的引导内容不明确：</strong></p><p>log.error(“get gw group ip segment failed. zkPath: “ + LockResource.getGwGroupIpSegmnetLockPath(request.getGwGroupId()));</p><p>zkPath ? 如何去排查这个问题？我该去找谁？到哪里去查找更具体的线索？</p><p>解决方案：加上相应的背景知识和引导排查措施。</p><p><strong>5. 错误内容不够具体细致：</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (!ncResourceService.isNcResourceEnough(ncResourceDO,    vmResourceCondition)) {</span><br><span class="line">      log.error("disk space is not enough at vm's nc, nc id:" + vmDO.getNcId());</span><br><span class="line">      throw new BizException(ResourceErrorCode.ERROR_RESOURCE_NOT_ENOUGH);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>究竟是什么资源不够？目前剩余多少？现在需要多少？值得注意的是， 要指明这些要额外做一些事情， 可能会稍微影响性能。这时候需要权衡性能和可调试性。</p><p>解决方案：通过改进程序或程序技巧， 尽可能揭示出具体的差异所在， 减少人工比对的操作。</p><p><strong>6. 半英文句式读起来不够清晰明白，需要思考来拼凑起完整的意思：</strong></p><p>log.warn(“cache status conflict, device id “+deviceDO.getId()+” db status “+deviceDO.getStatus() +”, nc status “+ status);</p><p>改为:</p><p>log.warn(String.format(“[query cache status] device cache status conflicts between regiondb and nc, status of device ‘%s’ in regiondb is %s , but is %s in nc.”, deviceDO.getId(), deviceDO.getStatus(), status));</p><p>解决方案：改为自然可读的英文句式。</p><p>总结起来， 错误日志格式可以为：</p><p>log.error(“[接口名或操作名] [Some Error Msg] happens. [params] [Probably Because]. [Probably need to do].”);</p><p>log.error(String.format(“[接口名或操作名] [Some Error Msg] happens. [%s]. [Probably Because]. [Probably need to do].”, params));</p><p>或</p><p>log.error(“[Some Error Msg] happens to 错误参数或内容 when [in some condition]. [Probably Because]. [Probably need to do].”);</p><p>log.error(String.format(“[Some Error Msg] happens to %s when [in some condition]. [Probably Because]. [Probably need to do].”, parameters));</p><p>[Probably Reason]. [Probably need to do]. 在某些情况下可以省略；在一些重要接口和场景下最好能说明一下。</p><p>每一条错误日志都是独立的，尽可能完整、具体、直接说明何种场景下发生了什么错误，由什么原因导致，要采用什么措施或步骤。</p><p>问题：</p><p>1.String.format 的性能会影响打日志吗？一般来说， 错误日志应该是比较少的， 使用 String.format 的频度并不会太高，不会对应用和日志造成影响。</p><p>2.开发时间非常紧张时， 有时间去斟酌字句吗？建立一个标准化的内容格式，将内容往格式套，可以节省斟酌字句的时间。</p><p>3.什么时候使用 info, warn , error ?</p><p>info 用于打印程序应该出现的正常状态信息， 便于追踪定位；</p><p>warn 表明系统出现轻微的不合理但不影响运行和使用；</p><p>error 表明出现了系统错误和异常，无法正常完成目标操作。</p><p><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/2031163/when-to-use-log-level-warn-vs-error">http://stackoverflow.com/questions/2031163/when-to-use-log-level-warn-vs-error</a></p><p>错误日志是排查问题的重要手段之一。当我们编程实现一项功能时， 通常会考虑可能发生的各种错误及相应原因：</p><p>要排查出相应的原因， 就需要一些关键描述来定位原因。这就会形成三元组：</p><p>错误现象 -&gt; 错误关键描述 -&gt; 最终的错误原因。</p><p>需要针对每一种错误尽可能提供相应的错误关键描述，从而定位到相应的错误原因。</p><p>也就是说，编程的时候，要仔细思考， 哪些描述是非常有利于定位错误原因的， 尽可能将这些描述添加到错误日志中。</p><p>文中没有指出的问题或困难， 请提出你的建议。</p></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%BD%AC%E8%BD%BD/">转载</a></div><div class="post-share"><div class="social-share" data-image="/img/34d5bb5d3744e6d1d83703ab0e20da2f_xll.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/312572753/" title="如何彻底理解红黑树"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">如何彻底理解红黑树</div></div><div class="info-2"><div class="info-item-1">作者**：linzworld cnblogs.com/linzworld/p/13720477.html 前言本文主要讲解下最近一直听到的红黑树，看看究竟是什么神仙鬼怪。 二叉树满足以下两个条件的树就是二叉树： 本身是有序树（若将树中每个结点的各子树看成是从左到右有次序的(即不能互换)，则称该树为有序树(Ordered Tree)）； 树中包含的各个节点的度不能超过 2，即只能是 0、1 或者 2； 简单地理解，二叉树（Binary tree）是每个节点最多只有两个分支（即不存在分支度大于2的节点）的树结构。通常分支被称作“左子树”或“右子树”。 二叉查找树要了解红黑树之前，免不了先看下二叉查找树是什么。 维基百科上的定义二叉查找树（英语：Binary Search Tree），也称为二叉搜索树、有序二叉树（ordered binary tree）或排序二叉树（sorted binary tree），是指一棵空树或者具有下列性质的二叉树 若任意节点的左子树不空，则左子树上所有节点的值均小于它的根节点的值； 若任意节点的右子树不空，则右子树上所有节点的值均大于或等于它的根节...</div></div></div></a><a class="pagination-related" href="/posts/1696090382/" title="Java后端线上问题排查常用命令收藏"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Java后端线上问题排查常用命令收藏</div></div><div class="info-2"><div class="info-item-1">作者：xiaolyuh 本文来源：http://r6d.cn/b97q7 内存瓶颈freefree是查看内存使用情况，包括物理内存、交换内存(swap)和内核缓冲区内存。 free -h -s 3表示每隔三秒输出一次内存情况，命令如下 123456789101112[1014154@cc69dd4c5-4tdb5 ~]$ free total used free shared buff/cache availableMem: 119623656 43052220 45611364 4313760 30960072 70574408Swap: 0 0 0[1014154@cc69dd4c5-4tdb5 ~]$ free -h -s 3 total used free shared buff/cache availableMem: ...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/3028893647/" title="SpringBoot 参数校验组件"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-24</div><div class="info-item-2">SpringBoot 参数校验组件</div></div><div class="info-2"><div class="info-item-1">一坨一坨的 if/else 参数校验，终于被 SpringBoot 参数校验组件整干净了！数据的校验的重要性就不用说了，即使在前端对数据进行校验的情况下，我们还是要对传入后端的数据再进行一遍校验，避免用户绕过浏览器直接通过一些 HTTP 工具直接向后端请求一些违法数据。 最普通的做法就像下面这样。我们通过 if/else 语句对请求的每一个参数一一校验。 这样的代码，小伙伴们在日常开发中一定不少见，很多开源项目都是这样对请求入参做校验的。 但是，不太建议这样来写，这样的代码明显违背了 单一职责原则。大量的非业务代码混杂在业务代码中，非常难以维护，还会导致业务层代码冗杂！ 实际上，我们是可以通过一些简单的手段对上面的代码进行改进的！这也是本文主要要介绍的内容！ 废话不多说！下面我会结合自己在项目中的实际使用经验，通过实例程序演示如何在 SpringBoot 程序中优雅地的进行参数验证(普通的 Java 程序同样适用)。 不了解的朋友一定要好好看一下，学完马上就可以实践到项目上去。 并且，本文示例项目使用的是目前最新的 Spring Boot 版本 2.4.5!（截止到 2021-...</div></div></div></a><a class="pagination-related" href="/posts/1696090382/" title="Java后端线上问题排查常用命令收藏"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-24</div><div class="info-item-2">Java后端线上问题排查常用命令收藏</div></div><div class="info-2"><div class="info-item-1">作者：xiaolyuh 本文来源：http://r6d.cn/b97q7 内存瓶颈freefree是查看内存使用情况，包括物理内存、交换内存(swap)和内核缓冲区内存。 free -h -s 3表示每隔三秒输出一次内存情况，命令如下 123456789101112[1014154@cc69dd4c5-4tdb5 ~]$ free total used free shared buff/cache availableMem: 119623656 43052220 45611364 4313760 30960072 70574408Swap: 0 0 0[1014154@cc69dd4c5-4tdb5 ~]$ free -h -s 3 total used free shared buff/cache availableMem: ...</div></div></div></a><a class="pagination-related" href="/posts/312572753/" title="如何彻底理解红黑树"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-24</div><div class="info-item-2">如何彻底理解红黑树</div></div><div class="info-2"><div class="info-item-1">作者**：linzworld cnblogs.com/linzworld/p/13720477.html 前言本文主要讲解下最近一直听到的红黑树，看看究竟是什么神仙鬼怪。 二叉树满足以下两个条件的树就是二叉树： 本身是有序树（若将树中每个结点的各子树看成是从左到右有次序的(即不能互换)，则称该树为有序树(Ordered Tree)）； 树中包含的各个节点的度不能超过 2，即只能是 0、1 或者 2； 简单地理解，二叉树（Binary tree）是每个节点最多只有两个分支（即不存在分支度大于2的节点）的树结构。通常分支被称作“左子树”或“右子树”。 二叉查找树要了解红黑树之前，免不了先看下二叉查找树是什么。 维基百科上的定义二叉查找树（英语：Binary Search Tree），也称为二叉搜索树、有序二叉树（ordered binary tree）或排序二叉树（sorted binary tree），是指一棵空树或者具有下列性质的二叉树 若任意节点的左子树不空，则左子树上所有节点的值均小于它的根节点的值； 若任意节点的右子树不空，则右子树上所有节点的值均大于或等于它的根节...</div></div></div></a><a class="pagination-related" href="/posts/1362641175/" title="服务端如何防止订单重复支付"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-24</div><div class="info-item-2">服务端如何防止订单重复支付</div></div><div class="info-2"><div class="info-item-1">服务端如何防止订单重复支付！ 作者：废物大师兄 www.cnblogs.com/cjsblog/p/14516909.html 如图是一个简化的下单流程，首先是提交订单，然后是支付。支付的话，一般是走支付网关（支付中心），然后支付中心与第三方支付渠道（微信、支付宝、银联）交互，支付成功以后，异步通知支付中心，支付中心更新自身支付订单状态，再通知业务应用，各业务再更新各自订单状态。 这个过程中经常可能遇到的问题是掉单，无论是超时未收到回调通知也好，还是程序自身报错也好，总之由于各种各样的原因，没有如期收到通知并正确的处理后续逻辑等等，都会造成用户支付成功了，但是服务端这边订单状态没更新，这个时候有可能产生投诉，或者用户重复支付。 由于③⑤造成的掉单称之为外部掉单，由④⑥造成的掉单我们称之为内部掉单 为了防止掉单，这里可以这样处理： 1、支付订单增加一个中间状态“支付中”，当同一个订单去支付的时候，先检查有没有状态为“支付中”的支付流水，当然支付（prepay）的时候要加个锁。支付完成以后更新支付流水状态的时候再讲其改成“支付成功”状态。 2、支付中心这边要自己定义一个超时时间（...</div></div></div></a><a class="pagination-related" href="/posts/1040342123/" title="Spring 事务失效的 12 种场景"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-24</div><div class="info-item-2">Spring 事务失效的 12 种场景</div></div><div class="info-2"><div class="info-item-1">太坑了！聊聊 Spring 事务失效的 12 种场景前言 对于从事java开发工作的同学来说，spring的事务肯定再熟悉不过了。 在某些业务场景下，如果一个请求中，需要同时写入多张表的数据。为了保证操作的原子性（要么同时成功，要么同时失败），避免数据不一致的情况，我们一般都会用到spring事务。 确实，spring事务用起来贼爽，就用一个简单的注解：@Transactional，就能轻松搞定事务。我猜大部分小伙伴也是这样用的，而且一直用一直爽。 但如果你使用不当，它也会坑你于无形。 今天我们就一起聊聊，事务失效的一些场景，说不定你已经中招了。不信，让我们一起看看。 一 事务不生效1.访问权限问题众所周知，java的访问权限主要有四种：private、default、protected、public，它们的权限从左到右，依次变大。 但如果我们在开发过程中，把有某些事务方法，定义了错误的访问权限，就会导致事务功能出问题，例如： 123456789@Servicepublic class UserService { @Transactional private...</div></div></div></a><a class="pagination-related" href="/posts/3216271943/" title="消息队列中如何保证消息的顺序性"><div class="cover" style="background:var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-24</div><div class="info-item-2">消息队列中如何保证消息的顺序性</div></div><div class="info-2"><div class="info-item-1">本文选自：advanced-java 作者：yanglbme 问：如何保证消息的顺序性？ 面试官心理分析其实这个也是用 MQ 的时候必问的话题，第一看看你了不了解顺序这个事儿？第二看看你有没有办法保证消息是有顺序的？这是生产系统中常见的问题。 面试题剖析我举个例子，我们以前做过一个 mysql binlog 同步的系统，压力还是非常大的，日同步数据要达到上亿，就是说数据从一个 mysql 库原封不动地同步到另一个 mysql 库里面去（mysql -&gt; mysql）。常见的一点在于说比如大数据 team，就需要同步一个 mysql 库过来，对公司的业务系统的数据做各种复杂的操作。 你在 mysql 里增删改一条数据，对应出来了增删改 3 条 binlog 日志，接着这三条 binlog 发送到 MQ 里面，再消费出来依次执行，起码得保证人家是按照顺序来的吧？不然本来是：增加、修改、删除；你楞是换了顺序给执行成删除、修改、增加，不全错了么。 本来这个数据同步过来，应该最后这个数据被删除了；结果你搞错了这个顺序，最后这个数据保留下来了，数据同步就出错了。 先看看顺序会错乱的...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/34d5bb5d3744e6d1d83703ab0e20da2f_xll.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info-name">小白</div><div class="author-info-description">这里是小白的小天地，简单记录自己的编程笔记、学习心得和日常点滴，分享一路成长的思考与收获。</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">82</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">52</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/187821551/" title="SSH问题经验">SSH问题经验</a><time datetime="2025-08-10T07:58:13.000Z" title="Created 2025-08-09 23:58:13">2025-08-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/3028893647/" title="SpringBoot 参数校验组件">SpringBoot 参数校验组件</a><time datetime="2023-08-24T08:00:00.000Z" title="Created 2023-08-24 00:00:00">2023-08-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/1696090382/" title="Java后端线上问题排查常用命令收藏">Java后端线上问题排查常用命令收藏</a><time datetime="2023-08-24T08:00:00.000Z" title="Created 2023-08-24 00:00:00">2023-08-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/209595582/" title="如何使错误日志更加方便排查问题">如何使错误日志更加方便排查问题</a><time datetime="2023-08-24T08:00:00.000Z" title="Created 2023-08-24 00:00:00">2023-08-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/312572753/" title="如何彻底理解红黑树">如何彻底理解红黑树</a><time datetime="2023-08-24T08:00:00.000Z" title="Created 2023-08-24 00:00:00">2023-08-24</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2019 - 2025 By 小白 </span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div><div class="footer_custom_text">京ICP备2023004911号-1</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional and Simplified Chinese">简</button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/pluginsSrc/instant.page/instantpage.js" type="module"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/pluginsSrc/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"></div><script src="/pluginsSrc/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!0,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> Loading Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>